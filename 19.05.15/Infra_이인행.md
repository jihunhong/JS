# RAS 검토하기

### RAS
- Reliability : 신뢰성
- Availability : 가용성
- Serviceability : 유지 보수성

### RASIS
- RAS + Integrity : 무결성
- Security : 안전성

### RAS 검토할 때 아래와 같은 지표를 사용한다
- 가동률 = MTBF / (MTBF+MTTR)
- MTBF = 누적 사용 시간 / 고장 횟수 (장애 발생 간격 = Mean Time Between Failures)
- MTTR = 누적 수리 시간 / 고장 횟수 (평균 복구 시간 = Mean Time To Repaire)
- ex) 브라우저 : 사용자가 액세스를 해도 화면이 표시되지 않거나 기능을 이용할 수 없는 시간

### 가동률을 높이기 위해서는
- 서비스 제공을 위해 필요한 장비의 최소 대수를 N이라고 하면, 평상시에 N+1(혹은 N+2)대를 준비해둔다.
- 다중화 : 시스템의 어느 구성 요소에서 장애가 발생한 경우에 다른 구성 요소가 그 처리를 넘겨받는것
- 단일 장애 포인트(SPOF, Single Point Of Failure) : 시스템의 구성 요소 중 다중화되어 있지 않은 단일 구성 요소
  - 단일 장애 포인트를 없애거나, 남아 있는 경우에는 MTBF를 길게, MTTR을 짧게 하는 방향으로 조정한다.
- 서버용 부품을 사용한다.
  - CPU, 메모리, 하드디스크, SSD 등에 서버용 제품을 따로 사용하며, 전용 장소에 서버를 설치한다.
- 부품을 이중화 한다.
  - 디스크의 RAID 구성
  - 전원 장치의 이중화
- 요소 각각의 가동률을 확인한다.
  - 사용자가 시스템을 이용하기 위해 사용하는 모든 서버에 대해 빠짐없이 확인한다.
  - 웹 서비스의 경우라면 서버뿐만 아니라 데이터 센터, 인터넷 회선, DNS 등에 대해서도 확인한다.

### 다중화
- Active-Active : 다중화된 요소를 모두 이용할 수 있다.
- Active-Standby : 다중화된 요소 중 한쪽은 이용할 수 없다.
  - Hot Standby : Standby 측은 기동 후 즉시 이용 가능한 구성
  - Warm Standby : Standby 측은 기동 후 이용 가능하게 하기 위해서 나름대로의 준비가 필요한 구성
  - Cold Standby : Standby 측을 정지시켜 두는 구성
- **Active-Active가 가장 가동률이 높아진다.**
  - Stateless가 가능한 부분들은 Active-Active 방식을 취하도록 한다.
  - 데이터베이스 서버나 파일 서버 등 데이터를 저장하는 부분을 Active-Active로 하면 대개는 데이터 정합성 유지를 위해 동기화가 필요하기 때문에 동작이 느려지므로 주의가 필요하다.

### 적절한 프로비저닝으로 부하 문제를 피한다.
- 프로비저닝 : 사용자 수 등을 예측하여 적절하게 리소스를 준비하는 것
- 스케일 업 : 서버 등 각 요소의 성능을 향상시키는 방법
  - 어느 정도의 규모까지는 스케일 업이 좋지만, 일정 범위를 넘어서는 순간 비용대비 효과가 나빠진다.
- 스케일 아웃 : 서버 등 각 요소의 수를 늘리는 방법
  - 오토 스케일링 : 클라우드 기반에서 제공하며, 자동 스케일링을 설정하는 것이 가능하다.
  - 오토 스케일을 사용하더라도 부하의 증가 속도를 따라잡지 못할 수도 있기 때문에 주의할 필요가 있다.

# 인프라 기술의 기초 지식

### IP 주소
- 글로벌 IP 주소 : 전 세계적으로 중복되지 않도록 관리되고 있으며, 글로벌 통신에 이용된다.
- 로컬 IP 주소 : 회사나 가정 등에서 자유롭게 사용 가능하며, 인터넷을 하는 경우에는 네트워크 안의 어느 기기인가가 글로벌 IP도 함께 가지고 있게 되므로, 그 기기가 통신을 중계함으로써 인터넷과 통신할 수 있다.
  - 10.0.0.0 ~ 10.255.255.255 : 매우 큰 규모의 네트워크용
  - 172.16.0.0 ~ 172.31.255.255 : 중간 규모의 네트워크용
  - 192.168.0.0 ~ 192.168.255.255 : 작은 규모의 네트워크용
  - 127.0.0.1 ~ 127.255.255.254 : 로컬 루프백 주소

### HTTP 헤더의 항목
- HOST : 목적지의 도메인을 나타낸다.
- Connection : 접속을 유지할 것인가, 곧바로 끊을 것인가 등의 접속에 관한 정보를 나타낸다.
- Pragma : 메시지에 관한 추가 정보를 나타낸다.
- Cache-Control : 메시지가 경유하는 중간 캐시의 동작을 지시한다.
- Accept : 클라이언트의 수용 가능한 콘텐츠 종류를 나타낸다.
- User-Agent : 클라이언트의 웹 브라우저 등의 정보를 나타낸다.
- Accept-Encoding : 클라이언트의 수용 가능한 문자 인코딩을 나타낸다.
- Accept-Language : 클라이언트의 수용 가능한 언어를 나타낸다.
- Cookie : 클라이언트의 상태 관리 정보를 서버에 반환한다.
- Date : 응답의 작성 날짜와 시간을 나타낸다.
- Server : 서버 업체 이름, 버전 번호를 나타낸다.
- Accept-Ranges : 객체의 일부에 대한 요청을 서버가 수용할 수 있는지를 나타낸다.
- Vary : 서버가 응답 내용을 결정할 때, 응답 URI 이외에 이용한 헤더 목록을 나타낸다.
- Content-Encoding : 콘텐츠의 인코딩을 나타낸다.
- Content-Length : 콘텐츠의 크기를 바이트 단위로 나타낸다.
- Content-Type : 콘텐츠의 종류를 나타낸다.

### CPU, 메모리의 스펙과 선택 방법
- 소켓 수 : CPU 장착 가능 수량
- 코어 수 : CPU 당 코어 개수
- 스레드 수 : CPU 당 스레드 수(Hyper Threading 대응의 CPU에서 카탈로그에 표시된 스레드 수는 코어 개수의 2배가 된다)
- 동작 주파수 : CPU의 동작 주파수(2.4GHz 등)
- 버전(세대) : Intel사의 CPU라면 Nehalem, IvyBridge 등
- **캐시 메모리 크기** : CPU 내장 메모리의 용량
- 최대 메모리 크기 : 장착 가능한 메모리의 최대 크기
- 최대 메모리 대역폭 : 장착 가능한 메모리의 최대 대역폭
- ECC 메모리 대응 여부 : ECC(오류 정정) 기능이 있는 메모리 대응 여부
- 서버용 CPU는 동작 주파수를 제외한 나머지 부분들에 대해 데스크톱용 CPU보다 월등히 높다.
- 일반적으로 동작 주파수가 높은 CPU는 일괄 처리와 같이 병렬도가 낮은 처리를 단시간에 완료하기 위한 용도로 사용하며, 스레드 수가 많은 CPU는 웹 서버와 같이 병렬도가 높은 용도에 사용한다.
- 멀티테넌트형 : 하나의 서버를 여러 사용자가 함께 사용하는 형식의 클라우드 서비스
  - 다른 사용자의 이용률에 영향을 받는 경우가 많기 때문에 엄격하게 따지지 말고 있는 그대로를 받아 들인다.
  - 다른 가상 서버로 옮기는 등의 대책도 좋은 방법이다.

### 디스크의 스펙과 선택 방법
- 하드디스크의 주요 선정 기준
  - 용량 : 250GB, 500GB, 1TB, 3TB 등
  - 인터페이스 규격 : SAS 6Gbps/3Gbps, SATA 6Gbps/3Gbps 등
  - 회전 수 : 15000rpm, 10000rpm, 7200rpm 등
  - 크기 : 2.5inch, 3.5inch
- 인터페이스 규격에 따라 최대 통신 속도가 결정되기 때문에 가능한 한 빠른 규격을 사용하도록 한다.
- SATA는 대용량, 저가격이며, SAS는 고성능, 높은 신뢰성(잘 부서지지 않음)이다.
- 서버 디스크를 결정할 때 디스크 자체보다 적절한 RAID 카드를 선택하는 것이 더 중요하다.
- RAID의 종류와 특징은 다음과 같다.
- RAID 0 : 디스크를 여러 대 사용하여 전체를 저장 영역으로 한다. 따라서 액세스 속도의 향상과 OS 측면에서의 디스크 용량 증가를 구현할 수 있다. 하지만 디스크 한 대라도 고장이 발생하면 전체에 문제가 생기므로, **데이터는 잃어도 무관하지만 용량과 엑세스 속도가 필요할 때** 이용한다.
- RAID 1 : 디스크 한 대에 데이터를 저장하고 백업을 준비한다. 액세스 속도와 용량은 한 대일 때와 같지만, 한 대가 고장 나도 문제가 없는 다중성이 향상된다.
- RAID 5 : 데이터로부터 패리티를 생성하여 데이터와 패리티를 함께 여러 대의 디스크에 분산 저장한다. **액세스 속도의 향상과 디스크 용량이 모두 필요할 때** 이용한다. 디스크 한 대까지는 고장이 발생해도 괜찮지만, 한 대가 고장 나면 곧바로 수리해야 한다.
- RAID 6 : 데이터로부터 패리티를 2중으로 생성하여 데이터와 패리티를 함께 여러 대의 디스크에 분산 저장한다. **액세스 속도의 향상과 디스크 용량이 모두 필요할 때** 이용한다. 디스크 두 대까지는 고장이 발생해도 괜찮기 때문에 수리 완료까지는 시간적인 여유가 있다.
- RAID 10 : RAID0과 RAID1을 조합한 것
- RAID 50 : RAID0과 RAID5를 조합한 것
- RAID 60 : RAID0과 RAID6을 조합한 것
- 최근에 PCI express 플래시 스토리지가 등장 하였는데 하드디스크나 SSD보다 압도적으로 성능이 뛰어나기 때문에 성능을 높이고 싶은 경우 검토해 보는 것도 좋은 방법이다. (매우 비싸다)

### 네트워크의 스펙과 선택 방법
- 서버에 접속하는 네트워크의 대역은 1Gbps가 일반적이며, 대개는 메인보드에 내장되어 있다.
- 최근에는 10Gbps 제품도 나와 있다.
- 서버 기기에 따라서는 케이블의 연결 포트가 2~6개까지 있는 것도 있다.
- 예를 들어 5개의 포트라면 외부 서비스 통신용으로 2선, 내부 서비스 용으로 2선, 관리 통신용으로 1선 등으로 사용할 수 있다.
- 다중화나 부하 분산도 고려하여 필요한 수량을 준비하는 것이 좋다.

### 방화벽 선택 방법
- 제조사 : 제품의 제조사. Cisco, FortiNet, Juniper 등
- 대응 프로토콜 : 필터링 가능한 프로토콜
- NAT 세션의 수 : NAT 이용 시 동시에 이용 가능한 세션의 수
- FW 스루풋 : 필터링 이용 시의 스루풋
- FW 규칙의 수 : 이용 가능한 필터링 규칙의 수
- 다중화 대응 : 대응 가능한 다중화 방식
- 방화벽 기능을 활성화했을 경우의 스루풋(통신속도)이 제시되어 있기 때문에 주의할 필요가 있다.
- 네트워크 기기 등의 스펙은 보통 카탈로그 스펙의 70~80% 정도가 기준이 된다.
  - 카탈로그에 200Mbps라고 쓰여 있으면 약 150Mbps

### 스위치의 선택 방법
- 접속 규격 : 이용 가능한 접속 규격. 1000Base-T, 1000Base-Tx 등
- VLAN 대응 : VLAN 이용 가능 여부
- 인텔리전트 기능 : 인텔리전트 기능 유무
- VLAN : 하나의 물리적인 네트워크상에 여러 개의 논리적인 네트워크를 구축하는 기능
- 인텔리전트 기능 : 스위치가 IP 주소를 가지고 있어서 SSH나 SNMP 등으로 감시 및 관리할 수 있는 기능

### 다중화의 구조
- 다중화는 어떤 데이터가 올바른 것인지, 가장 최신의 것인지를 제대로 관리해야 한다.
- 또한 여러 개의 데이터가 정확하게 일치하고 상태를 유지해야만 한다.
- Shared Disk 방식
  - 하나의 스토리지를 공유하며, 대개는 전용 스토리지 기기를 이용한다.
  - 스토리지를 공유하기 때문에 정합성에 대해 특별히 문제될 것이 없다.
  - 정합성은 확보 되지만, 오버헤드가 클 수 있다.
  - 또한, Shared Disk 자체를 다중화해야 한다는 과제가 남는다.
- Shared Nothing 방식
  - 여러 스토리지가 스토리지 간에 통신을 하여 데이터 정합성을 확보한다.
  - 데이터 손실이 발생할 수도 있지만 성능 저하의 정도가 작다.
  - 데이터 송신 측을 Master, 데이터 수신 측을 Slave라고 한다.
  - Multi-Master라고 하여 각각 Master와 Slave의 역할을 모두 갖는 방식도 있지만, 문제가 많이 발생하기 때문에 잘 사용하지 않는다.
- 페일오버(failover) : Standby였던 것이 Active로 바뀌는 것을 '승격'이라고 하며, 이 과정에서 일어나는 일련의 동작을 뜻한다.
  - 페일오버를 자동화할 때는 Linux-HA가 제공하는 'Heartbeat'이나 'Pacemaker' 드의 소프트웨어를 많이 사용한다.
  - 그 밖에 Virtual Router Redundancy Protocol(VRRP)도 있다. VRRP는 네트워크 기기인 라우터를 다중화하기 위한 프로토콜이지만, 이를 이용해 서버를 다중화할 수도 있다.
  - Heartbeat나 Pacemaker와 자주 조합하여 사용되는 것으로 Distributed Replicated Block Device(DRBD)라는 스토리지 시스템이 있다. 이를 사용하면 Shared Nothing 방식이라도 Shared Disk처럼 사용할 수 있고, Active-Standby에서 이용하는 것을 추천한다.
- Split Brain : Active가 다운되지 않았음에도 Standby가 승격해 버리는 상태
  - 이러한 상태가 발생하면 데이터의 정합성을 잃어 큰 문제가 될 수 있다.
  - 최악의 사태를 피하기 위해 Standby가 승격할 때 Active를 강제로 정지시키는 STONITH를 이용한다.
  - STONITH(Shoot The Other Node In The Head) : Standby가 승격할 때 Active의 BIOS에 강제 정지 명령을 내리는 등의 조치를 하여 Split Brain이 발생하는 것을 방지한다.

# 웹 서비스 서버 구성의 모범 사례

### 기본적인 시스템 구성
- 다중화 : 같은 기능과 역할의 기기를 여러 대 준비하여 단일 기기의 고장에 따른 영향이 시스템 전체에 미치지 않도록 함으로써 시스템 전체의 가용성을 높인다.
- 기능 분할 : 1대로 여러 기능을 제공하고 있는 경우, 서버를 기능별로 준비하여 1대당 처리 부하를 감소시켜 시스템 전체의 성능을 향상시킨다.
- 스케일 업 : 구성은 변경하지 않고 서버 자체의 성능을 향상시킴으로써 시스템 전체의 성능을 향상시킨다.
- 스케일 아웃 : 같은 기능과 역할의 기기를 여러 대 준비하여 처리를 분담시킴으로써 시스템 전체의 성능을 향상시킨다.
- 패턴 1 : 웹서버 1, 데이터베이스 서버 1 : 기능 분할
  - 웹서버(Web---File)---데이터베이스 서버(DB) 또는
  - 웹서버(Web)---데이터베이스 서버(DB, File)
- 패턴 2 : 웹 서버 2 : 다중화
  - 서버1(운용서버 = Web---DB, File) : DB와 File은 대기용 서버와 동기화
  - 서버2(대기용 서버 = Web---DB, File)
- 패턴 3 : 웹 서버 2, 데이터베이스 서버 1 : 다중화, 기능 분할, 스케일 아웃
  - 웹서버1(Web)---데이터베이스 서버(DB, File)
  - 웹서버2(Web)_|
- 패턴 4 : 웹 서버 2, 데이터베이스 서버 2 : 다중화, 기능 분할, 스케일 아웃
  - 웹서버1(Web)---데이터베이스 서버(운용서버=DB, File) : 대기용 데이터베이스 서버와 동기화
  - 웹서버2(Web)_|
  - 데이터베이스 서버(대기용서버=DB, File)
  - 대기용 데이터베이스 서버에 SQL을 통해 데이터를 얻을 수는 있지만, 부하의 관점에서는 의미가 없으며 가용성이 떨어지기 때문에 사용하지 않는 것이 좋다.

### 로드밸런싱
- 로드밸런서 : 서버측(수신측)에 부하를 분산할 수 있는 구조를 제공한다. 대부분 소프트웨어로 구현된 것을 사용하고 있다. 
  - 클라이언트가 서버 측으로 액세스할 때마다 연결할 서버를 변경한다.
  - 의도한 대로 확실하게 분산할 수 있다는 장점이 있다.
  - 하지만, 로드밸런서가 단일 장해 포인트가 되지 않도록 로드밸런서의 다중화도 고려해야 한다.
  - 또한 로드밸런서가 보틀넥이 된 경우에는 로드밸런서의 성능을 높일 필요가 있다.
- DNS 라운드로빈 : 클라이언트 측의 동작에 의존적인 방법이다.
  - DNS에서의 IP 주소를 설정할 때 여러 개의 IP를 설정하도록 한다.
  - 대부분 클라이언트가 첫 번째 IP 주소를 이용할 때, 보통의 브라우저는 첫 번째 IP 주소에 접속할 수 없는 경우 두 번째 IP 주소로 다시 시도하게 되어 있다.
  - 추가 설비가 필요하지 않다는 장점이 있다.
  - 하지만 문제 발생 시 장비의 신속한 전환은 기대하기 어렵다.
  - 또한 클라이언트 측이 브라우저가 아닌 시스템인 경우에는 재시도 기능을 활용하지 못하여 가용성의 향상 효과를 얻지 못할 수도 있다.
- 결과적으로 기본적으로는 로드밸런서를 이용하면서 DNS 라운드로빈을 적당히 함께 사용하는 것이 좋다.

### 로드밸런서의 종류
- L4 로드밸런서 : OSI 계층에서 말하는 4계층(TCP, UDP)까지를 처리한다.
  - 처리하는 계층이 조금 더 좁기 때문에 처리량이 줄어들어 로드밸런서가 부하의 보틀넥이 되기는 어렵다.
  - L4-NAT와 L4-DSR이 있다.
  - L4-DSR은 수Gbps가 넘는 대량의 트래픽이 발생하는 시스템에서 사용한다.
- L7 로드 밸런서 : 7계층(HTTP, SMTP 등)을 모두 처리한다.
  - 많은 계층을 처리하는 고기능인 만큼 L4와 비교하면 부하의 보틀넥이 되기 쉽다.
- 우선 L4-NAT와 L7을 검토한 다음, 만족되지 않을 경우 L4-DSR이나 DNS 라운드로빈을 검토하는 것이 좋다.
![123](https://user-images.githubusercontent.com/20277647/57768313-56409580-7746-11e9-9d5a-d184872f5e23.PNG)

### 로드밸런서에서의 분산 목적지 결정 방법
- 라운드로빈
  - 기본적으로는 특별히 아무것도 신경 쓰지 않고 분산 목적지 목록에 있는 순서대로 액세스를 분산한다.
  - 매우 쉽지만, 분산 목적지 서버의 상태를 고려하지 않기 때문에 부하가 높아진 서버로도 액세스를 분산해 버린다.
  - ex) 서버1, 서버2, 서버3, 서버4, 서버1, 서버2, 서버3, 서버4, ...
- 가중 라운드로빈
  - 라운드로빈과 같은 방식이지만, 지정한 가중치에 따라 특정 분산 목적지에 많게 또는 적게 액세스를 분산한다.
  - 예를 들어, 서버1 : 서버2 : 서버3 : 서버4 = 1 : 2 : 2 : 2 의 가중치인 경우 2~4에는 서버 1의 2배 만큼 액세스를 분산시킨다.
  - ex) 서버1, 서버2, 서버3, 서버4, 서버2, 서버3, 서버4, 서버1, 서버2, 서버3, 서버4...
- 최소 커넥션
  - 접속 수가 적은 서버에 액세스를 분산한다.
  - ex) 서버1(접속25), 서버2(접속50), 서버3(접속50), 서버4(접속50) ---> 서버1에 분산
  - 가중 최소 커넥션으로 1:2:2:2의 가중치를 가진다면 4개의 서버가 동일한 확률로 액세스가 분산
- 헬스체크 기능 : 일정 간격으로 분산 목적지의 응답 여부를 확인하여 응답이 없는 분산 목적지를 제외하는 기능
  - 헬스 체크 인터벌 : 응답 여부를 확인하는 간격으로, 대개 수 초로 설정한다.
  - 문제가 생긴 분산 목적지는 신속하게 목적지 목록에서 삭제되지만, 문제 발생 후 목적지 목록에서 삭제되는 동안 그 목적지 서버를 액세스한 경우에는 에러가 발생한다.
  - 고기능 로드밸런서는 에러를 반환하지 않고 다른 목적지로 다시 접속하는 기능을 가진 것도 있다.

# 인프라 준비의 기초 지식

### 꼭 필요한 요구사항 정리하기
- 기능적 요건과 비 기능적 요건을 파악한 후 무엇을 어떻게 할 것인지 결정한다.
- 개발자로부터의 기능적 요건, 액세스 수나 사용자 수 등의 목표 수치, 관련 행정기관이나 법률 등의 대응과 같은 것들으 고려하여 선정한다.
- 성능과 관련된 수치는 선정 시기에 직접 사용해보지 않으면 알 수 없기 때문에 시작한 후에라도 유연하게 대응할 수 있는 클라우드를 이용하는 것이 더 좋다.
- 선정 시에는 인터넷 회선의 대역, 서버 대수, 서버의 스펙과 같은 다양한 선정 기준을 이용할 수 있다.
- 이 중에서 어떤 부분을 어느 정도의 기간과 비용으로 변경할 수 있으며, 어떤 부분을 변경할 수 없는지 확인하는 것이 좋다.

### 인터넷 회선의 용량 계산
- 각 페이지의 대략적인 데이터량을 추정하고, 이를 바탕으로 인터넷 회선에 필요한 용량을 계산한다.
- ex) 1페이지당 처음 표시되는 데이터 용량 1.6MB, 2회 이후 800KB
  - 피크시간(22:00~24:00)의 총 방문자 수 20000명
  - 1회 방문 시 평균 4페이지 열람
- 1초당 필요한 회선의 용량 = 피크시간의 방문자 수 * (처음 표시되는 데이터 용량 + 2회째 표시 데이터 용량 + 3회째 + 4회째) / 피크시간의 시간
- 20000명 * (1.6+0.8+0.8+0.8)MB / 7200초 = 11.1111....MBS = 89 Mbps
- 카탈로그 스펙의 70~80%가 실측값으로 나온다는 가정하에, 상위의 회숸 대역이나 방화벽을 선정할 경우 카탈로그 스펙이 최소한 150Mbps가 되는 제품을 선정하는 것이 좋다.

### 서버 대수의 용량 계산
- 앞의 예에서 2시간 동안 20000 명이 4PV(Page View)씩 한 것으로 계산된다.
- 즉, 2시간에 80000PV가 된다.
- 여기서 1PV의 처리에 5초가 소요된다고 가정해 본다.
- 80000PV를 2시간(7200초)으로 평균을 내면 매초당 11.11...PV 즉, 12PV 만큼의 액세스가 발생한다.
- PV당 5초 동안 서버의 리소스를 이용하므로 초당 최대 60 병렬의 처리가 필요한 것을 알 수 있다.
- 일반적인 웹 사이트라면 CPU가 4개인 서버로 50병렬 정도는 처리가 가능하므로, 결론적으로 서버는 최소 2대 또는 다중성을 고려하여 3대 이상이 기준이 된다.
- 또한 병렬 수가 증가하면 서버뿐만 아니라 네트워크 기기에 대한 고려도 필요해질 수 있다.
- 물리적인 환경인 경우 상위의 네트워크 기기는 최대 병렬 수가 정해져 있기 때문에 미리 용량을 확인하는 것이 좋다.

### 인프라 구축 후 확인해야 하는 것
- 툴을 사용해 확인한다.
  - 서버 구성이 의도대로 되어 있는가
  - 소프트웨어가 빠짐없이 설치되어 있으며, 설치하고자 했던 버전이 맞는가
  - 로그인하여 애플리케이션을 디플로이할 수 있는가, 업데이트를 반영할 수 있는가
  - https://serverspec.org/
- 애플리케이션을 디플로이한 후 성능 테스트와 장애 테스트를 한다.
  - 예상했던 성능이 나오는가
  - 최대 성능은 어느 정도인가
  - 피크타임의 시간대에 장시간 가동시켜도 문제가 발생하지 않는지
  - 부하를 생성하는 툴을 사용한다. (Apache Bench, JMeter 등)
  - 부하를 거는 쪽에도 충분한 성능 및 충분한 서버를 준비하는 것이 좋다.
  - 시스템의 부하를 확인하고 보틀넥을 찾아내는 툴을 사용한다. (vmstat, dstat, top, Cacti, mackerel, Newrelic 등)
  - 부하를 걸어 오류의 발생이 일정 확률 이하가 되는 최대 성능을 확인한다.
  - 최대 성능에 근접하거나 조금 넘는 정도에서 시스템이 어떻게 손상되어 가는지, 어디가 보틀넥이 되는지를 확인함으로써 감시 및 설비투자를 위한 포인트를 판단할 수 있다.
  - 각 요소를 의도적으로 손상시켜 시스템 동작에 어떤 영향이 있는지, 복구 순서는 예상대로인지 확인한다. (LAN 케이블이나 전원 케이블 제거, 클라우드인 경우 네트워크를 차단 또는 강제 종료)
  - 백업으로부터의 복구가 예상한 순서로 수행 가능한지 확인한다.
  - 각 순서에 번호를 매겨 예상되는 사용자 영향, 예상 동작, 예상 복구 방법을 정리한다.

### 백업
- 백업시 확인해야 하는것1. 대상 데이터
  - 어느 서버의 어떤 데이터를 저장할 것인가
- 백업시 확인해야 하는것2. 백업 타이밍
  - 어느 타이밍에 백업을 할 것인가 결정한다. (매일, 월 1회 등)
- 백업시 확인해야 하는것3. 백업의 방법
  - 어떻게 백업을 할 것인가를 결정한다.
  - 백업 방법이 잘못되면 연동하고 있는 다수의 파일 내용이 백업 처리 중에 변경되는 등의 사태가 발생하여 정합성이 결여된 데이터가 백업되어 버릴 수도 있다.
- 백업시 확인해야 하는것4. 저장 장소
  - 백업 데이터를 어디에 저장할 것인가
  - 같은 서버, 같은 네트워크, 같은 데이터 센터 안에서 백업하는 경우는 별로 좋지 않다.
- 백업시 확인해야 하는것5. 저장 세대의 수
  - 백업 데이터를 몇 세대 동안 저장하고 관리할 것인가

# 웹 서비스 운용1 : 시스템 감시의 기본

### 정상 상태를 (감시 항목 + 정상적인 결과)의 형태로 정의하기
- 정상 상태를 정의한다.
  - 처음에는 요건의 정의나 현황부터 아는대로 간단하게 정의하고, 운용해 가면서 차츰 확장한다.
  - 경험자의 조언이나 감시용 툴에 포함되어 있는 템플릿 등을 적극적으로 활용한다.
- 한계값을 정의한다.
  - 요구되는 기능적 요건과 비 기능적 요건을 만족하는지 확인한다.
  - 경보가 최대한 감소하도록 조정해야 한다.
  - 잘못된 경보나 불필요한 경보는 발생하지 않도록 한다.
- 시스템 감시에 관해서 확인하고자 하는 항목을 직접 확인한다.
  - 평균 부하가 높아지면 응답 시간이 길어진다고 해서 평균 부하를 응답 시간의 기준으로 하지 말고, 응답 시간을 직접 감시하도록 한다.

### 정상 상태가 아닐 때의 대응 방법을 감시 항목마다 정의한다.
- 먼저 전체적인 방침으로서 복구 우선인지 재발 방지 우선인지를 검토하여 협의한다.
  - 웹 시스템이나 미디어 사이트는 복구 우선인 경우가 대부분이다.
- 연락 방법과 같은 운용의 흐름을 고려하여 정한다.
  - 연락 방법과 연락 순서 등을 정한다.
- 대응 방침을 복구 우선으로 결정한 경우에는 분석에 시간을 허비하지 않도록 하여 복구를 서두르도록 절차를 짠다.
  - 재발의 위험성은 남지만, 재발하더라도 다시 신속하게 복구한다면 크게 문제되지 않는 경우가 많다.
- 대응 방법을 결정할 때는 상황의 정도에 따라 잘 분류한다.
  - 완전히 다운된 경우가 아닌 응답이 느려지는 경우 등 미묘한 경우에 대해서도 어떠한 방침으로 대응할 것인지 정해두는 것이 좋다.

### 정상 상태인 것을 지속적으로 확인한다.
- 지속적인 확인을 위해 툴을 사용하며, 필요에 따라 인력을 함께 이용한다.
  - Nagios, Zabbix, Monit 등의 툴이 있다.

### 정상 상태가 아닌 경우 정상 상태로 복구 시킨다.
- 1차 대응(잠정 대응)과 2차 대응(근본 대응)으로 나누고, 정의 단계에서 결정한 방침에 따라 실시한다.
- 예상치 못한 사고가 발생할 경우 누구에게 어떻게 연락해야 하며 그 사람이 어떤 권한을 가질 것인가 등을 명확히 해 두는 것이 좋다.
- 감시 항목의 추가나 삭제, 한계값의 변경, 대응 방법의 변경 등 운용 중의 경험을 수시로 절차에 적용하여 절차와 팀을 확장해 나간다.

### 감시 툴과 모니터링 툴
- 시스템 감시는 가급적 상위 계층에서 실제 사용자의 조작에 가까운 형식으로 성과를 감시한다.
- 시스템 리소스에 대한 감시는 리소스 모니터링과는 별도로 생각하는 것이 좋다.
  - 리소스 모니터링은 정기적으로 1개월 단위, 6개월 단위 등 장시간 동안의 경향을 검토하는 것을 추천한다.
- 감시 툴은 Nagios나 Zabbix가 주로 사용된다.
- 모니터링 툴은 Cacti, Munin, GrowthForecast가 주로 사용된다.

### 감시 항목 파악하기
- 외형 감시 : 시스템의 외부 접속 상황을 감시한다.
  - 설계 단계에서 명확하게 정의해 둔 기능적 요건을 바탕으로 감시 항목을 작성한다.
  - 방화벽 설정에서 포트가 의도적으로 열려있는 것은 감시해야 할 항목인 경우가 많다.
  - ex) HTTP 응답 코드, 내용, 응답 시간, 크기
  - ex) HTTPS 응답 코드, 내용, 응답 시간, 크기
  - ex) POP, SMTP, FTP... 동작 여부, 메일 송수신이나 파일 PUT/GET 등
  - ex) HTTP 시나리오
- 내부 감시 : 시스템의 내부를 감시한다.
  - 서비스 가동 상황 감시
  - 시스템 리소스 감시
  - ex) CPU 사용률, 평균 부하, 디스크별 사용률, 디스크별 대기 시간
  - ex) 네트워크 인터페이스별 트래픽 IN/OUT, 로컬에서의 HTTP 접속
  - ex) 서비스에 사용할 프로세스의 감시(apache, nginx, mysqld 등)
  - ex) 시스템적으로 사용할 프로세스의 감시(ntpd, snmpd 등)

### 감시의 구현 방법
- 액티브 체크 : 감시 서버 쪽에서 능동적으로 체크하는 방법
  - 이상을 빠짐없이 감지할 수 있다는 장점이 있다.
  - 체크 간격이 돌아올 때까지는 이상을 감지할 수 없기 때문에 감시 대상이 보고를 할 수 있는 상황에서는 패시브 체크 쪽이 오히려 실시간성이 높다.
- 패시브 체크 : 감시의 대상 쪽에서 이상을 감지하여 감시 서버로 보고하는 방식
  - 감시 대상이 이상을 보고하지 못하고 다운된 경우 이상을 감지할 수 없다는 단점이 있다.
- 감시 에이전트를 이용하여 효율적인 감시를 구현하는 것이 좋다.
  - Nagios는 NRPE, Zabbix는 Zabbix 에이전트

### 장애가 발생했을 때의 대응 방법
- 경보
  - 경보 뿐만 아니라 사용자나 관계자로부터의 문의가 계기가 되는 경우도 있다.
- 현상 확인
  - 일차적으로 직접 눈으로 사이트의 표시 등을 확인하고, 실제로 현상이 발생하고 있는지를 추가로 확인한다.
  - 현상이 확인되면 대응 단계로 넘어간다.
  - 현상이 확인되지 않으면 대응이 불필요하다고 판단한다.
  - 눈 앞에서 발생하지 않지만 사용자 측에서 계속 발생하고 있는 경우에는 대응 단계로 넘어간다.
  - 이 경우에는 재현 방법을 모르더라도 현상을 해소하는 것을 최선으로 생각하고 대응한다.
- 1차 대응
  - 문제가 발생했지만, 원래는 정상이었던 것들이기 때문에 대부분 고쳐지기 마련이다.
  - 당연한 것을 냉정하게 그리고 제대로 처리하는 것이 중요하다.
  - 해결까지 생각하지 말고 일단 문제를 회피하는 것만으로도 충분하니 신속하게 대응한다.
  - 작업 로그를 남기는 것이 중요하다.
- 경보 현상 및 다른 항목 확인하기
  - 대응을 완료했으면 경보 현상이 해소되었는지 확인하고, 동시에 다른 현상이 발생하지 않았는지도 확인한다.
- 사후 작업
  - 복구가 완료되었으면 관련된 각처에 보고하고 근본적인 대응을 검토하는 등의 사후 작업을 진행한다.
  - 재발 방지, 원인 분석, 상세 보고는 다음 영업일 이후에 하도록 한다.

### 대규모 장애 발생 시의 대응
- 팀으로 역할 분담한다.
  - 대응 담당 : 실제로 조사 및 대응을 하는 역할, 장애 대응은 기술이 부족한 사람이 하게 되면 시간을 들여도 대응이 되지 않으므로 대응 기술을 가진 사람을 지정한다.
  - 정보 관리 담당 : 언제 어떤 것들을 했는지, 언제 어떤 상황이었는지, 현재 어떤 상황인지를 계속해서 기록 및 갱신한다.
  - 커뮤니케이션 창구 담당 : 고객 및 사내의 다른 팀 등과의 소통 창구 역할을 한다.
  - 지휘 담당 : 전체를 살펴보며 대응할 사항과 순서 및 대응 방법을 선택하고, 대응 담당과 상담하며 대응 방침을 그때그때 조정한다.
  - 지휘 담당은 무조건 한 사람으로 하고, 확실하게 교대제로 한다.
- 냉정하게 정보를 파악하고 전체를 바라본다.
  - 장애의 영향이 어디까지 미치고 있는지, 조치해야 할 부분이 어디인지를 지속적으로 냉정하게 파악한다.
  - 대규모 장애에 따른 영향의 수, 종류, 양이 방대해져 의외로 대응 내용을 빠뜨리기 쉬워지므로 빠짐없는 대응을 위해 항상 필요한 대응사항 목록을 작성하여 유지, 관리한다.
- 2차 재해가 발생하지 않도록 한다.

### 항상 발생하는 장애의 관리와 리뷰
- 장애 사례 축적
  - 발생한 장애와 대응 과정을 축적한다.
  - 이때는 메일링 리스트나 BTS(Bug Tracking System)을 사용하는 것이 좋으며, 반드시 장애별로 개별 ID를 부여하는 것이 좋다.
  - BTS로는 trac, Redmine이 유명하다.
- 한 가지 현상에 대해 다수의 경보가 발생하는 경우가 있으니, 집계할 때는 그 부분을 잘 처리하도록 한다.
- 가용성을 보기 위해서라면 전체 항목을 대상으로 하지 말고 외형적인 서비스의 감시 항목을 기준으로 한다.
  - 가용성을 산출할 때, 디스크 사용량이나 평균 부하 등 사용자의 이용에 영향이 없는 경보는 집계를 해도 의미가 없다.
  - 혹시 지연되고 있는 것이 아닌가 하는 걱정이 된다면 액세스 로그에서 직접 확인한다.
